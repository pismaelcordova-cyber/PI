<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EcoAzuay - Plataforma Ambiental</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      margin: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    #app { 
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    #header {
      background: rgba(255, 255, 255, 0.98);
      padding: 15px 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    #header h1 {
      font-size: 24px;
      color: #11998e;
      margin: 0;
    }
    #mainContent { 
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #panel { 
      background: rgba(255, 255, 255, 0.98);
      width: 350px;
      padding: 20px;
      overflow-y: auto;
      box-shadow: 4px 0 20px rgba(0,0,0,0.1);
    }
    #map { 
      flex: 1;
      height: 100%;
    }
    .box { 
      background: white;
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      border-left: 4px solid #11998e;
    }
    .box-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin-bottom: 14px;
    }
    .form-group {
      margin-bottom: 14px;
    }
    .form-label {
      display: block;
      font-weight: 600;
      font-size: 13px;
      color: #495057;
      margin-bottom: 6px;
    }
    input[type="text"], 
    textarea, 
    select { 
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    textarea { 
      min-height: 90px;
      resize: vertical;
    }
    .grid2 { 
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    button { 
      padding: 12px 18px;
      cursor: pointer;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      background: #11998e;
      color: white;
      width: 100%;
      margin-top: 8px;
    }
    button:hover {
      background: #0e8070;
    }
    .btn-warning {
      background: #ffc107;
    }
    .btn-warning:hover {
      background: #e0a800;
    }
    .category-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .category-btn {
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      color: #495057;
    }
    .category-btn:hover {
      border-color: #11998e;
    }
    .category-btn.selected {
      border-color: #11998e;
      background: #11998e;
      color: white;
    }
    .category-icon {
      font-size: 24px;
      display: block;
      margin-bottom: 4px;
    }
    .severity-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .severity-btn {
      padding: 10px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
    }
    .severity-btn.low { border-color: #28a745; color: #28a745; }
    .severity-btn.medium { border-color: #ffc107; color: #e0a800; }
    .severity-btn.high { border-color: #dc3545; color: #dc3545; }
    .severity-btn.selected { color: white; }
    .severity-btn.low.selected { background: #28a745; }
    .severity-btn.medium.selected { background: #ffc107; }
    .severity-btn.high.selected { background: #dc3545; }
    .otros-fields {
      display: none;
      margin-top: 12px;
      padding: 14px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 2px dashed #11998e;
    }
    .otros-fields.show {
      display: block;
    }
    .message {
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 13px;
      text-align: center;
      font-weight: 600;
      display: none;
    }
    .message.show {
      display: block;
    }
    .message.success {
      background: #d4edda;
      color: #155724;
    }
    .message.error {
      background: #f8d7da;
      color: #721c24;
    }
    .message.info {
      background: #d1ecf1;
      color: #0c5460;
    }
  </style>
</head>

<body>
<div id="app">
  <div id="header">
    <h1>üå± EcoAzuay</h1>
  </div>

  <div id="mainContent">
    <div id="panel">
      <!-- DENUNCIAS -->
      <div class="box">
        <div class="box-title">üì¢ Nueva Denuncia Ambiental</div>
        
        <div class="form-group">
          <label class="form-label">Categor√≠a del problema</label>
          <div class="category-grid" id="denunciaCategories">
            <div class="category-btn" data-cat="ruido">
              <span class="category-icon">üîä</span>
              Ruido
            </div>
            <div class="category-btn" data-cat="basura">
              <span class="category-icon">üóëÔ∏è</span>
              Basura
            </div>
            <div class="category-btn" data-cat="quema">
              <span class="category-icon">üî•</span>
              Quema
            </div>
            <div class="category-btn" data-cat="tala">
              <span class="category-icon">üå≤</span>
              Tala
            </div>
            <div class="category-btn" data-cat="agua">
              <span class="category-icon">üíß</span>
              Agua
            </div>
            <div class="category-btn" data-cat="aire">
              <span class="category-icon">üí®</span>
              Aire
            </div>
            <div class="category-btn" data-cat="otro">
              <span class="category-icon">üìù</span>
              Otro
            </div>
          </div>
        </div>

        <div id="denunciaOtrosFields" class="otros-fields">
          <div class="form-group">
            <label class="form-label">Especifica el tipo de problema</label>
            <input type="text" id="denunciaOtroTipo" placeholder="Ej: Contaminaci√≥n sonora...">
          </div>
          <div class="form-group">
            <label class="form-label">Cant√≥n</label>
            <select id="denunciaCanton">
              <option value="">Selecciona un cant√≥n</option>
              <option value="Cuenca">Cuenca</option>
              <option value="Gir√≥n">Gir√≥n</option>
              <option value="Gualaceo">Gualaceo</option>
              <option value="S√≠gsig">S√≠gsig</option>
              <option value="Paute">Paute</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Parroquia</label>
            <input type="text" id="denunciaParroquia" placeholder="Ingresa la parroquia">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Nivel de gravedad</label>
          <div class="severity-grid" id="denunciaSeverity">
            <div class="severity-btn low" data-sev="bajo">Bajo</div>
            <div class="severity-btn medium" data-sev="medio">Medio</div>
            <div class="severity-btn high" data-sev="alto">Alto</div>
          </div>
        </div>

        <button id="btnDenunciaGPS" class="btn-warning">üìç Obtener mi ubicaci√≥n</button>

        <div class="grid2">
          <input id="denunciaLat" placeholder="Latitud" readonly>
          <input id="denunciaLng" placeholder="Longitud" readonly>
        </div>

        <div class="form-group">
          <label class="form-label">Descripci√≥n detallada</label>
          <textarea id="denunciaDesc" placeholder="Describe el problema con el mayor detalle posible..."></textarea>
        </div>

        <button id="btnEnviarDenuncia">‚úâÔ∏è Enviar Denuncia</button>
        <div id="denunciaMsg" class="message"></div>
      </div>

      <!-- RESIDUOS -->
      <div class="box">
        <div class="box-title">‚ôªÔ∏è Publicar Residuo Disponible</div>
        
        <div class="form-group">
          <label class="form-label">Tipo de residuo</label>
          <div class="category-grid" id="residuoCategories">
            <div class="category-btn" data-cat="plastico">
              <span class="category-icon">üß¥</span>
              Pl√°stico
            </div>
            <div class="category-btn" data-cat="carton">
              <span class="category-icon">üì¶</span>
              Cart√≥n
            </div>
            <div class="category-btn" data-cat="metal">
              <span class="category-icon">‚öôÔ∏è</span>
              Metal
            </div>
            <div class="category-btn" data-cat="vidrio">
              <span class="category-icon">üçæ</span>
              Vidrio
            </div>
            <div class="category-btn" data-cat="organico">
              <span class="category-icon">üåø</span>
              Org√°nico
            </div>
            <div class="category-btn" data-cat="electronico">
              <span class="category-icon">üíª</span>
              Electr√≥nico
            </div>
            <div class="category-btn" data-cat="otro">
              <span class="category-icon">üìù</span>
              Otro
            </div>
          </div>
        </div>

        <div id="residuoOtrosFields" class="otros-fields">
          <div class="form-group">
            <label class="form-label">Especifica el tipo de residuo</label>
            <input type="text" id="residuoOtroTipo" placeholder="Ej: Neum√°ticos, bater√≠as...">
          </div>
          <div class="form-group">
            <label class="form-label">Cant√≥n</label>
            <select id="residuoCanton">
              <option value="">Selecciona un cant√≥n</option>
              <option value="Cuenca">Cuenca</option>
              <option value="Gir√≥n">Gir√≥n</option>
              <option value="Gualaceo">Gualaceo</option>
              <option value="S√≠gsig">S√≠gsig</option>
              <option value="Paute">Paute</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Parroquia</label>
            <input type="text" id="residuoParroquia" placeholder="Ingresa la parroquia">
          </div>
        </div>

        <button id="btnResiduoGPS" class="btn-warning">üìç Obtener mi ubicaci√≥n</button>

        <div class="grid2">
          <input id="residuoLat" placeholder="Latitud" readonly>
          <input id="residuoLng" placeholder="Longitud" readonly>
        </div>

        <div class="form-group">
          <label class="form-label">Descripci√≥n del residuo</label>
          <textarea id="residuoDesc" placeholder="Ej: 50kg de cart√≥n limpio..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Cantidad estimada</label>
          <input type="text" id="residuoCantidad" placeholder="Ej: 50 kg">
        </div>

        <div class="form-group">
          <label class="form-label">Contacto (opcional)</label>
          <input type="text" id="residuoContacto" placeholder="WhatsApp, email o tel√©fono">
        </div>

        <button id="btnPublicarResiduo">üöÄ Publicar Residuo</button>
        <div id="residuoMsg" class="message"></div>
      </div>
    </div>

    <div id="map"></div>
  </div>
</div>

<script>
window.addEventListener('load', function() {
  if(typeof L === 'undefined' || typeof window.supabase === 'undefined') {
    alert('Error cargando librer√≠as');
    return;
  }
  initApp();
});

function initApp() {
  const SUPABASE_URL = "https://ovzxjronqcvwyuwvkofn.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92enhqcm9ucWN2d3l1d3Zrb2ZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NDgyMzEsImV4cCI6MjA4MTQyNDIzMX0.TcAY2HkP_QbmxJiDUqCwTJ7cP_F8rmsUYoLS6VydTq4";
  const TELEGRAM_BOT_TOKEN = "8277312443:AAFsNhI69gQKtbPX5EYEZGYwwHMmzgUKM1w";
  const TELEGRAM_CHAT_ID = "5495683947";
  
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  const map = L.map("map").setView([-2.9, -79.0], 9);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);
  
  let denunciasLayer = L.layerGroup().addTo(map);
  let residuosLayer = L.layerGroup().addTo(map);
  let userMarker = null;
  
  let selectedDenunciaCategory = '';
  let selectedDenunciaSeverity = '';
  let selectedResiduoCategory = '';
  
  async function enviarNotificacionTelegram(tipo, datos) {
    try {
      let mensaje = '';
      
      if(tipo === 'denuncia') {
        const iconos = {ruido:'üîä',basura:'üóëÔ∏è',quema:'üî•',tala:'üå≤',agua:'üíß',aire:'üí®',otro:'üìù'};
        mensaje = `üö® NUEVA DENUNCIA\n\n${iconos[datos.categoria]} Categor√≠a: ${datos.categoria.toUpperCase()}\n`;
        if(datos.categoria === 'otro' && datos.otro_tipo) mensaje += `Tipo: ${datos.otro_tipo}\n`;
        mensaje += `Gravedad: ${datos.gravedad}\nUbicaci√≥n: ${datos.lat}, ${datos.lng}\n`;
        if(datos.canton) mensaje += `Cant√≥n: ${datos.canton}\n`;
        if(datos.parroquia) mensaje += `Parroquia: ${datos.parroquia}\n`;
        mensaje += `Descripci√≥n: ${datos.descripcion}\n\nMapa: https://maps.google.com/?q=${datos.lat},${datos.lng}`;
      } else {
        const iconos = {plastico:'üß¥',carton:'üì¶',metal:'‚öôÔ∏è',vidrio:'üçæ',organico:'üåø',electronico:'üíª',otro:'üìù'};
        mensaje = `‚ôªÔ∏è NUEVO RESIDUO\n\n${iconos[datos.tipo]} Tipo: ${datos.tipo.toUpperCase()}\n`;
        if(datos.tipo === 'otro' && datos.otro_tipo) mensaje += `Especificaci√≥n: ${datos.otro_tipo}\n`;
        mensaje += `Cantidad: ${datos.cantidad}\nUbicaci√≥n: ${datos.lat}, ${datos.lng}\n`;
        if(datos.canton) mensaje += `Cant√≥n: ${datos.canton}\n`;
        if(datos.parroquia) mensaje += `Parroquia: ${datos.parroquia}\n`;
        mensaje += `Descripci√≥n: ${datos.descripcion}\nContacto: ${datos.contacto}\n\nMapa: https://maps.google.com/?q=${datos.lat},${datos.lng}`;
      }
      
      await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({chat_id: TELEGRAM_CHAT_ID, text: mensaje})
      });
    } catch(error) {
      console.error('Error Telegram:', error);
    }
  }
  
  function mostrarMensaje(element, texto, tipo) {
    element.textContent = texto;
    element.className = `message show ${tipo}`;
    setTimeout(() => element.classList.remove('show'), 5000);
  }
  
  document.querySelectorAll('#denunciaCategories .category-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#denunciaCategories .category-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedDenunciaCategory = btn.dataset.cat;
      document.getElementById('denunciaOtrosFields').classList.toggle('show', selectedDenunciaCategory === 'otro');
    });
  });
  
  document.querySelectorAll('#denunciaSeverity .severity-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#denunciaSeverity .severity-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedDenunciaSeverity = btn.dataset.sev;
    });
  });
  
  document.querySelectorAll('#residuoCategories .category-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#residuoCategories .category-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedResiduoCategory = btn.dataset.cat;
      document.getElementById('residuoOtrosFields').classList.toggle('show', selectedResiduoCategory === 'otro');
    });
  });
  
  document.getElementById('btnDenunciaGPS').addEventListener('click', () => {
    if(!navigator.geolocation) {
      alert('Tu navegador no soporta GPS');
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      document.getElementById('denunciaLat').value = lat;
      document.getElementById('denunciaLng').value = lng;
      if(userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([lat, lng]).addTo(map).bindPopup('üìç Tu ubicaci√≥n');
      map.setView([lat, lng], 14);
    });
  });
  
  document.getElementById('btnResiduoGPS').addEventListener('click', () => {
    if(!navigator.geolocation) {
      alert('Tu navegador no soporta GPS');
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      document.getElementById('residuoLat').value = lat;
      document.getElementById('residuoLng').value = lng;
      if(userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([lat, lng]).addTo(map).bindPopup('üìç Tu ubicaci√≥n');
      map.setView([lat, lng], 14);
    });
  });
  
  document.getElementById('btnEnviarDenuncia').addEventListener('click', async () => {
    const lat = document.getElementById('denunciaLat').value;
    const lng = document.getElementById('denunciaLng').value;
    const desc = document.getElementById('denunciaDesc').value.trim();
    const msgEl = document.getElementById('denunciaMsg');
    
    if(!lat || !lng || !selectedDenunciaCategory || !selectedDenunciaSeverity || !desc) {
      mostrarMensaje(msgEl, '‚ö†Ô∏è Completa todos los campos', 'error');
      return;
    }
    
    let otroTipo = null, canton = null, parroquia = null;
    if(selectedDenunciaCategory === 'otro') {
      otroTipo = document.getElementById('denunciaOtroTipo').value.trim();
      canton = document.getElementById('denunciaCanton').value;
      parroquia = document.getElementById('denunciaParroquia').value.trim();
      if(!otroTipo || !canton || !parroquia) {
        mostrarMensaje(msgEl, '‚ö†Ô∏è Completa los campos de "Otro"', 'error');
        return;
      }
    }
    
    mostrarMensaje(msgEl, 'üì§ Enviando denuncia...', 'info');
    
    // Construir descripci√≥n completa incluyendo info de "Otro"
    let descripcionCompleta = desc;
    if(selectedDenunciaCategory === 'otro' && otroTipo) {
      descripcionCompleta = `[TIPO: ${otroTipo}] [CANT√ìN: ${canton}] [PARROQUIA: ${parroquia}] ${desc}`;
    }
    
    const {data, error} = await sb.from('denuncias').insert([{
      lat: parseFloat(lat),
      lng: parseFloat(lng),
      categoria: selectedDenunciaCategory,
      gravedad: selectedDenunciaSeverity,
      descripcion: descripcionCompleta,
      estado: 'reportado'
    }]).select();
    
    if(error) {
      mostrarMensaje(msgEl, `‚ùå Error: ${error.message}`, 'error');
    } else {
      // Crear objeto con info para Telegram
      const dataTG = {
        ...data[0],
        otro_tipo: otroTipo,
        canton: canton,
        parroquia: parroquia
      };
      await enviarNotificacionTelegram('denuncia', dataTG);
      mostrarMensaje(msgEl, '‚úÖ ¬°Denuncia enviada! Notificaci√≥n enviada a Telegram', 'success');
      document.getElementById('denunciaDesc').value = '';
      document.getElementById('denunciaLat').value = '';
      document.getElementById('denunciaLng').value = '';
      if(otroTipo) {
        document.getElementById('denunciaOtroTipo').value = '';
        document.getElementById('denunciaCanton').value = '';
        document.getElementById('denunciaParroquia').value = '';
      }
      selectedDenunciaCategory = '';
      selectedDenunciaSeverity = '';
      document.querySelectorAll('#denunciaCategories .category-btn').forEach(b => b.classList.remove('selected'));
      document.querySelectorAll('#denunciaSeverity .severity-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('denunciaOtrosFields').classList.remove('show');
    }
  });
  
  document.getElementById('btnPublicarResiduo').addEventListener('click', async () => {
    const lat = document.getElementById('residuoLat').value;
    const lng = document.getElementById('residuoLng').value;
    const desc = document.getElementById('residuoDesc').value.trim();
    const cantidad = document.getElementById('residuoCantidad').value.trim();
    const contacto = document.getElementById('residuoContacto').value.trim();
    const msgEl = document.getElementById('residuoMsg');
    
    if(!lat || !lng || !selectedResiduoCategory || !desc) {
      mostrarMensaje(msgEl, '‚ö†Ô∏è Completa todos los campos', 'error');
      return;
    }
    
    let otroTipo = null, canton = null, parroquia = null;
    if(selectedResiduoCategory === 'otro') {
      otroTipo = document.getElementById('residuoOtroTipo').value.trim();
      canton = document.getElementById('residuoCanton').value;
      parroquia = document.getElementById('residuoParroquia').value.trim();
      if(!otroTipo || !canton || !parroquia) {
        mostrarMensaje(msgEl, '‚ö†Ô∏è Completa los campos de "Otro"', 'error');
        return;
      }
    }
    
    mostrarMensaje(msgEl, 'üì§ Publicando residuo...', 'info');
    
    // Construir descripci√≥n completa incluyendo info de "Otro"
    let descripcionCompleta = desc;
    if(selectedResiduoCategory === 'otro' && otroTipo) {
      descripcionCompleta = `[TIPO: ${otroTipo}] [CANT√ìN: ${canton}] [PARROQUIA: ${parroquia}] ${desc}`;
    }
    
    const {data, error} = await sb.from('residuos').insert([{
      lat: parseFloat(lat),
      lng: parseFloat(lng),
      tipo: selectedResiduoCategory,
      descripcion: descripcionCompleta,
      cantidad: cantidad || 'No especificada',
      contacto: contacto || 'No proporcionado',
      disponible: true
    }]).select();
    
    if(error) {
      mostrarMensaje(msgEl, `‚ùå Error: ${error.message}`, 'error');
    } else {
      // Crear objeto con info para Telegram
      const dataTG = {
        ...data[0],
        otro_tipo: otroTipo,
        canton: canton,
        parroquia: parroquia
      };
      await enviarNotificacionTelegram('residuo', dataTG);
      mostrarMensaje(msgEl, '‚úÖ ¬°Residuo publicado! Notificaci√≥n enviada', 'success');
      document.getElementById('residuoDesc').value = '';
      document.getElementById('residuoCantidad').value = '';
      document.getElementById('residuoContacto').value = '';
      document.getElementById('residuoLat').value = '';
      document.getElementById('residuoLng').value = '';
      if(otroTipo) {
        document.getElementById('residuoOtroTipo').value = '';
        document.getElementById('residuoCanton').value = '';
        document.getElementById('residuoParroquia').value = '';
      }
      selectedResiduoCategory = '';
      document.querySelectorAll('#residuoCategories .category-btn').forEach(b => b.classList.remove('selected'));
      document.getElementById('residuoOtrosFields').classList.remove('show');
    }
  });
}
</script>
</body>
</html>